<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Random Emojis</title>
  <style>
    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      overflow: hidden;
    }

    #center-circle-container {
      position: relative;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      /* Makes it a perfect circle */
      overflow: hidden;
      background: #f9f9f9;
      /* light background to see boundary */
    }

    #player-circle-container {
      position: relative;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      /* Makes it a perfect circle */
      overflow: hidden;
      background: #f9f9f9;
      /* light background to see boundary */
    }

    .emoji {
      position: absolute;
      transform-origin: center center;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .emoji:hover {
      transform: scale(1.3) rotate(10deg);
    }

    .emoji.highlighted {
      box-shadow: 0 0 10px 10px gold;
      border-radius: 50%;
      background-color: rgba(255, 223, 0, 0.3);
      transition: all 0.3s ease;
    }

    .swal2-button {
      background-color: #3085d6;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .swal1-button {
      background-color: #ffffff;
      color: white;
      border: none;
      font-size: 25px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .swal2-button:hover {
      background-color: #256bb5;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div style="display: flex; justify-content: center; gap: 80px;">
    <div style="text-align: center;">
      <div style="font-weight: bold; margin-bottom: 10px;">CENTER</div>
      <div id="center-circle-container"
        style="position: relative; width: 400px; height: 400px; border: 2px solid #ccc; border-radius: 50%; margin: auto; margin-top: 50px;">
        {% for e in center_emojis %}
        <span class="emoji" data-index="{{ e.index }}"
          style="position: absolute; font-size: {{ e.size }}px; transform: rotate({{ e.rotation }}deg);"
          onclick="emojiClicked('{{ e.emoji }}', false)">
          {{ e.emoji }}
        </span>
        {% endfor %}
      </div>
    </div>

    <div style="text-align: center;">
      <div style="font-weight: bold; margin-bottom: 10px;">PLAYER</div>
      <div style="margin-bottom: 10px;">
        <button class="swal1-button" onclick="rotate('counterclockwise')">üîÑ</button>
        <button class="swal1-button" onclick="rotate('clockwise')">üîÅ</button>
      </div>
      <div id="player-circle-container"
        style="position: relative; width: 400px; height: 400px; border: 2px solid #ccc; border-radius: 50%; margin: auto; margin-top: -5px;">
        {% for e in player_emojis %}
        <span class="emoji" data-index="{{ e.index }}"
          style="position: absolute; font-size: {{ e.size }}px; transform: rotate({{ e.rotation }}deg);"
          onclick="emojiClicked('{{ e.emoji }}', true)">
          {{ e.emoji }}
        </span>
        {% endfor %}
      </div>
    </div>
  </div>

  <button class="swal2-button" onclick="shuffle()" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;">Shuffle Deck</button>

  <div id="scoreboard" style="
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px 15px;
    font-family: sans-serif;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  ">
    <table id="score-table">
      <thead>
        <tr id="name-row"></tr>
      </thead>
      <tbody>
        <tr id="score-row"></tr>
      </tbody>
    </table>
  </div>


  <script>
    function arrangeEmojiForAll() {
      arrangeEmoji('player-circle-container');
      arrangeEmoji('center-circle-container');
    }

    function arrangeEmoji(containerId) {
      const container = document.getElementById(containerId);
      const emojis = container.querySelectorAll('.emoji');
      const centerX = container.offsetWidth / 2;
      const centerY = container.offsetHeight / 2;
      const radius = container.offsetWidth / 2 - 60;

      emojis.forEach((emoji) => {
        const index = parseInt(emoji.getAttribute('data-index'));

        if (index === 0) {
          // center emoji
          emoji.style.left = `${centerX - emoji.offsetWidth / 2}px`;
          emoji.style.top = `${centerY - emoji.offsetHeight / 2}px`;
        } else {
          // outer 7 emojis
          let angle = (2 * Math.PI / 7) * (index - 1); // index 1-7
          let x = centerX + radius * Math.cos(angle);
          let y = centerY + radius * Math.sin(angle);

          emoji.style.left = `${x - emoji.offsetWidth / 2}px`;
          emoji.style.top = `${y - emoji.offsetHeight / 2}px`;
        }
      });
    }

    function updateCard(newCenterEmojis, newPlayerEmojis) {
      const centerContainer = document.getElementById('center-circle-container');
      const playerContainer = document.getElementById('player-circle-container');

      // Clear current emojis
      centerContainer.innerHTML = '';
      playerContainer.innerHTML = '';

      if (typeof newCenterEmojis === 'string' && newCenterEmojis.startsWith("DONE")) { // game over
        const winner = newCenterEmojis.split(" ")[1];
        Swal.fire({
          title: "Game Over",
          icon: "success",
          text: `Winner is ${winner} üéâ`,
          scrollbarPadding: false
        });
      } else {
        // Add new center emojis
        newCenterEmojis.forEach(e => {
          const span = document.createElement('span');
          span.className = 'emoji';
          span.setAttribute('data-index', e.index);
          span.style.fontSize = `${e.size}px`;
          span.style.transform = `rotate(${e.rotation}deg)`;
          span.onclick = () => emojiClicked(e.emoji, false);
          span.innerText = e.emoji;
          centerContainer.appendChild(span);
        });
      }

      // Add new player emojis
      newPlayerEmojis.forEach(e => {
        const span = document.createElement('span');
        span.className = 'emoji';
        span.setAttribute('data-index', e.index);
        span.style.fontSize = `${e.size}px`;
        span.style.transform = `rotate(${e.rotation}deg)`;
        span.onclick = () => emojiClicked(e.emoji, true);
        span.innerText = e.emoji;
        playerContainer.appendChild(span);
      });

      // Re-arrange after adding
      arrangeEmojiForAll();
    }

    function clearHighlights() {
      document.querySelectorAll('.emoji.highlighted').forEach(el => {
        el.classList.remove('highlighted');
      });
    }

    function highlightEmoji(containerId, emojiChar) {
      document.getElementById(containerId).querySelectorAll('.emoji').forEach(el => {
        if (el.textContent.trim() === emojiChar) {
          el.classList.add('highlighted');
        }
      });
    }

    function emojiClicked(emoji, isPlayer) {
      addr = isPlayer ? '/clickedPlayer' : '/clickedCenter';
      containerId = isPlayer ? 'player-circle-container' : 'center-circle-container';
      fetch(addr, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emoji: emoji })
      })
        .then(response => response.json())
        .then(data => { // for a nice popup message
          if (data && data.message) {
            Swal.fire({
              toast: true,
              position: 'top',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true,
              icon: 'info',
              title: data.message
            });
          }
          if (data && data.center_emojis && data.player_emojis) {
            updateCard(data.center_emojis, data.player_emojis);
          }
          if (data && data.highlight) {
            clearHighlights();
            highlightEmoji(containerId, data.highlight);
          }
          if (data && data.clear_highlight) {
            clearHighlights();
          }
          if (data && data.names && data.scores) { // update scoreboard
            updateScoreboard(data.names, data.scores)
          }
        });
    }

    function shuffle() {
      fetch('/shuffle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })
        .then(response => response.json())
        .then(data => { // for a nice popup message
          if (data && data.center_emojis == "DONE") {
            Swal.fire({
              title: "Cannot Shuffled",
              icon: "error",
              text: "No more cards in the center pile",
              scrollbarPadding: false
            });
          }
          else if (data && data.center_emojis && data.player_emojis && data.clear_highlight) {
            Swal.fire({
              title: "Shuffled",
              icon: "success",
              scrollbarPadding: false
            });
            clearHighlights();
            updateCard(data.center_emojis, data.player_emojis);
          }
        });
    }

    function updateScoreboard(names, scores) {
      const nameRow = document.getElementById('name-row');
      const scoreRow = document.getElementById('score-row');

      nameRow.innerHTML = '';  // Clear previous content
      scoreRow.innerHTML = '';

      names.forEach(name => {
        const th = document.createElement('th');
        th.textContent = name;
        th.style.padding = '0 10px';
        nameRow.appendChild(th);
      });

      scores.forEach(score => {
        const td = document.createElement('td');
        td.textContent = score;
        td.style.textAlign = 'center';
        td.style.padding = '4px 10px';
        scoreRow.appendChild(td);
      });
    }

    function rotate(direction) {
      fetch('/rotate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ direction: direction })
      })
        .then(response => response.json())
        .then(data => { // for a nice popup message
          if (data && data.center_emojis && data.player_emojis) {
            // clearHighlights();
            updateCard(data.center_emojis, data.player_emojis);
          }
          if (data && data.containerId && data.highlight) {
            highlightEmoji(data.containerId, data.highlight)
          }
        });
    }

    const init_names = {{ names | tojson }};
    const init_scores = {{ scores | tojson }};
    // Call it to populate
    updateScoreboard(init_names, init_scores);


    // Arrange the emojis once the page loads
    window.onload = arrangeEmojiForAll;
  </script>

</body>

</html>